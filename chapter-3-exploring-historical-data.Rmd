---
title: "Chapter 3: Exploring the Historical Data"
author: "Dan Nguyen"
date: "August 17, 2015"
output:
  md_document:
    variant: markdown_github
---

Questions to ask:

- Does Oklahoma have a lot of earthquakes compared to other states?
- Is the earthquake activity recent?
- Is Oklahoma unusual in the spike of earthquakes that it faces, compared to other states?
- How unusual is the intensity of the earthquakes?



## Setup

```{r, message = FALSE}
# Load libraries
library(ggplot2)
library(scales)
library(grid)
library(dplyr)
library(lubridate)
library(rgdal)

# load my themes:
source("./myslimthemes.R")
theme_set(theme_dan())

# create a data directory
dir.create('./data')

```

Download the map data as before:

```{r, message = F}
fname <- "./data/cb_2014_us_state_20m.zip"
if (!file.exists(fname)){
  url <- "http://www2.census.gov/geo/tiger/GENZ2014/shp/cb_2014_us_state_20m.zip"
  print(paste("Downloading: ", url))
  download.file(url, fname)
}
unzip(fname, exdir = "./data/shp")
```

Load the map data and make two versions of it:
- `states_map` removes all non-U.S. states, such as Washington D.C. and Guam:
- `cg_map` removes all non-contiguous states, e.g. Alaska and Hawaii.

```{r, message = F}
us_map <- readOGR("./data/shp/cb_2014_us_state_20m.shp", "cb_2014_us_state_20m")
states_map <- us_map[!us_map$STUSPS %in%
                        c('AS', 'DC', 'GU', 'MP', 'PR', 'VI'),]

```

We won't be mapping Alaska but including it is critical for analysis.


### Download the historical quake data

TK explanation.


```{r, message = F}
fn <- './data/usgs-quakes-dump.csv'
zname <- paste(fn, 'zip', sep = '.')
if (!file.exists(zname) || file.size(zname) < 2048){
  url <- paste("https://github.com/dannguyen/ok-earthquakes-RNotebook",
    "raw/master/data", zname, sep = '/')
  print(paste("Downloading: ", url))
  # note: if you have problems downloading from https, you might need to include
  # RCurl
  download.file(url, zname, method = "libcurl")
}
unzip(zname, exdir="data")
# read the data into a dataframe
usgs_data <- read.csv(fn, stringsAsFactors = FALSE)
nrow(usgs_data)
```



Add some convenience columns; use lubridate to add a `year` and `era` column:


```{r, message = F}

quakes <- mutate(quakes, time = as.Date(time), year = year(time)) %>%
          mutate(era = ifelse(year <= 2000, "1995-2000",
          ifelse(year <= 2005, "2001-2005",
          ifelse(year <= 2010, "2006-2010", "2011-2015"))))
```


Remove all non-earthquakes and events with magnitude less than 3.0:

```{r, message = F}
quakes <- usgs_data %>% filter(mag >= 3.0) %>%
  filter(type == 'earthquake')
nrow(quakes)
```


```{r, message = F}

# Create a spatial data frame----------------------------------
sp_quakes <- SpatialPointsDataFrame(data = quakes,
                          coords = quakes[,c("longitude", "latitude")])
sp_quakes@proj4string <- states_map@proj4string

# subset for earthquakes in the U.S.
xdf <- over(sp_quakes, states_map[, 'STUSPS'])
world_quakes <- cbind(sp_quakes, xdf)
states_quakes <- world_quakes %>% filter(!is.na(STUSPS))
nrow(states_quakes)
```



Add a `is_OK` conveneince column to `states_quakes`:

```{r}
states_quakes$is_OK <- states_quakes$STUSPS == "OK"
```


Let's try a map:

```{r}
# For mapping purposes, we'll make a contiguous-states only
cg_map <- states_map[!states_map$STUSPS %in% c('AK', 'HI'), ]
cg_quakes <- states_quakes[!states_quakes$STUSPS  %in% c('AK', 'HI'), ]
```

```{r}
ggplot() +
  geom_polygon(data = cg_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = cg_quakes, aes(x = longitude, y = latitude), shape = 1, color = "red", alpha = 0.2) +
  coord_map("albers", lat0 = 38, latl = 42) +
  theme_dan_map()

```


By era:

Legend hack: http://stackoverflow.com/questions/5290003/how-to-set-legend-alpha-with-ggplot2

```{r}
ggplot() +
  geom_polygon(data = cg_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = cg_quakes, aes(x = longitude, y = latitude, color = era), shape = 4,  alpha = 0.2) +
  coord_map("albers", lat0 = 38, latl = 42) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_dan_map()

```

Small multiples:

```{r}
ggplot() +
  geom_polygon(data = cg_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = cg_quakes, aes(x = longitude, y = latitude), shape = 4,  alpha = 0.2, color = "red") +
  coord_map("albers", lat0 = 38, latl = 42) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_dan_map() +
  facet_wrap(~ era)
```

Small multiples focused on Oklahoma:

```{r}
# Dataframe of just Oklahoma quakes:
ok_quakes <- filter(states_quakes, is_OK)
# map of just Oklahoma state:
ok_map <- states_map[states_map$STUSPS == 'OK',]
```

```{r, small_multiples_oklahoma_map_quakes, fig.cap = "Small Multiples Oklahoma"}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = ok_quakes, aes(x = longitude, y = latitude), shape = 4,  alpha = 0.5, color = "red") +
  coord_map("albers", lat0 = 38, latl = 42) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_dan_map() +
  facet_wrap(~ era) +
  ggtitle("M3.0+ Earthquakes in Oklahoma")
```






------

Let's circle back and see the overall scope.

Look at breakdown of earthquakes worldwide versus United States:

Total

```{r}
ggplot(data = world_quakes, aes(x = year)) +
  geom_histogram(binwidth = 1)
```


U.S. vs Non US:

```{r}
ggplot(data = world_quakes, aes(x = year, fill = is.na(STUSPS))) +
  geom_histogram(binwidth = 1) +
  scale_fill_manual(values = c("red", "gray"), labels = c("Within U.S.", "Outside U.S.")) +
  guides(fill = guide_legend(reverse = TRUE))
```


U.S. earthquakes only

```{r, message = F}
ggplot(data = states_quakes, aes(x = year)) +
  geom_histogram(binwidth = 1) +
  scale_y_continuous(expand = c(0, 0))
```


-----------

Plot a histogram of all of the earthquakes by state since 1995, and highlight Oklahoma in orange:


```{r, message = F}
ggplot(states_quakes, aes(STUSPS)) +
   geom_histogram(binwidth = 1, width = 0.5) +
   geom_histogram(data = filter(states_quakes, is_OK), binwidth = 1, fill="#FF6600", width = 0.5) +
   scale_y_continuous(expand = c(0, 0)) +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.6)) +
   ggtitle("U.S. Earthquakes Since 1995")
```

Reduce the noise by filtering out states. Only a few states have a significant number of earthquakes.

Order the x-axis by count: http://stackoverflow.com/questions/20041136/how-to-avoid-ggplot-sorting-the-x-axis-while-plotting-geom-bar


```{r, message = F}
# Apparently there's a reorder() convention...rather than look that up, I've just decided to set the factor manually
qcounts <- states_quakes %>% group_by(STUSPS) %>% summarise(count = n()) %>%
    arrange(desc(count))
# create a vector
qcounts$x1 <- factor(qcounts$STUSPS, levels = qcounts$STUSPS)
ggplot(qcounts, aes(x1, count)) +
  scale_y_continuous(expand = c(0, 0)) +
  geom_bar(width = 0.5, stat = "identity") +
  geom_bar(data = filter(qcounts, STUSPS == "OK"), stat = "identity", fill = "#FF6600", width = 0.5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.6)) +
  ggtitle("U.S. Earthquakes Since 1995")

```

Pick top 12:

```{r, message = F}
top_states <- head(qcounts, 12)$STUSPS
top_quakes <- filter(states_quakes, states_quakes$STUSPS %in% top_states)
```




Plot a histogram of the earthquakes by state, before and after 2010:


```{r, message = F}
top_quakes$x1 <- factor(top_quakes$STUSPS, levels = top_states)
ggplot(top_quakes, aes(x = x1, fill = year < 2010)) +
  geom_histogram(binwidth = 1) +
  scale_fill_manual(values = c("#990000", "#DDCCCC"), labels = c("2010-2015", "1995-2010"), guide = guide_legend(reverse = TRUE)) +
 theme(axis.text.x = element_text(
   face = ifelse(levels(top_quakes$x1) =="OK","bold","italic"),
   color = ifelse(levels(top_quakes$x1) =="OK","#FF6600","#444444"))
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  ggtitle("Earthquakes (3.0+ mag) among top 12 U.S. states\nby overall earthquake activity.")
```


This graph is a little visually misleading, because the `1995-2010` category spans __15 years__, versus the __5__ years for `2010-2015`. But that only underscores the unusual frequency of Oklahoma's recent earthquakes.








## Within comparisons: OK year over year

Let's focus our look at just Oklahoma:

```{r}
ggplot(data = ok_quakes, aes(year)) +
  scale_y_continuous(expand = c(0, 0)) +
  geom_histogram(binwidth = 1, fill = "#DDCCCC") +
  geom_histogram(data = filter(ok_quakes, year >= 2012 & year < 2015), binwidth = 1,
                 fill="#990000") +
  geom_histogram(data = filter(ok_quakes, year == 2015), binwidth = 1, fill="#BB0000") +
  stat_bin( data = filter(ok_quakes, year >= 2012),
            aes(ymax = (..count..),
            # feels so wrong, but looks so right...
            label = ifelse(..count.. > 0, ..count.., "")),
            binwidth = 1, geom = "text", vjust = 1.5, size = 3.5,
            fontface = "bold", color = "white" ) +
  ggtitle("Oklahoma M3+ earthquakes, from 1995 to August 2015")
```

Oklahoma earthquakes by month, since 2008

```{r}
# This manual creation of breaks is the least awkward way I know of creating a
# continuous scale from month-date and applying it to stat_bin for a more
# attractive graph
mbreaks = as.numeric(seq(as.Date('2008-01-01'), as.Date('2015-08-01'), '1 month'))
ggplot(data = filter(ok_quakes, year >= 2008),
       aes(x = floor_date(time, 'month')), y = ..count..) +
  stat_bin(breaks = mbreaks, position = "identity") +
  stat_bin(data = filter(ok_quakes, floor_date(time, 'month') == as.Date('2011-11-01')),
          breaks = mbreaks, position = 'identity', fill = 'red') +
  scale_x_date(breaks = date_breaks("year"), labels = date_format("%Y")) +
  scale_y_continuous(expand = c(0, 0)) +
  annotate(geom = "text", x = as.Date("2011-11-01"), y = 50, size = rel(3.5), vjust = 0.0, color = "#DD6600",
           label = "November 2011\nRecord M5.6 earthquake hits Oklahoma") +
  ggtitle("Oklahoma M3+ earthquakes since 2008, by month")
```

Focus on November 2011:

```{r}
ggplot(data = filter(ok_quakes, year == 2011, month(time) == 11),
       aes(x = floor_date(time, 'day'))) +
  geom_histogram(binwidth = 1, color = "white") +
  scale_x_date(breaks = date_breaks('week'),
               labels = date_format("%b. %d"),
               expand = c(0, 0),
               limits = c(as.Date("2011-11-01"), as.Date("2011-11-30"))) +
  scale_y_continuous(expand = c(0, 0)) +
  ggtitle("Oklahoma M3+ earthquakes during the month of November 2011")
```




--------------

## Something Small Multiples


```{r, earthquake_activity_top_states_by_year, message = F}
top_quakes_ge_2005 <- filter(top_quakes, year >= 2005)
g <- ggplot(top_quakes_ge_2005, aes(factor(year))) +
    # draw orange box around oklahoma
    geom_rect(data = filter(top_quakes_ge_2005, is_OK), color = '#FF6600', fill = "#fDf2e9", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, size = 0.3, linetype = 'dashed') +
  geom_histogram(binwidth = 1, fill = "#999999", width = 0.8)  +
  geom_histogram(data = filter(top_quakes_ge_2005, year >= 2012), binwidth = 1, fill="#CC0000", width = 0.8) +
  scale_x_discrete(breaks = c(2006, 2010, 2014)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 600))
g + facet_wrap(~ STUSPS, ncol = 4) + theme(panel.margin = unit(c(1, 1, 1, 1), "lines")) +
  ggtitle("Annual number of M3.0+ earthquakes for states with most earthquake activity")
```



## TKTK pie

```{r, earthquake_activity_pie_era,  message = F}

pct_quakes <- states_quakes %>%
  filter(STUSPS %in% top_states) %>%
  group_by(era, STUSPS) %>%
  summarise(count = length(STUSPS)) %>%
  group_by(STUSPS) %>% mutate(pct = count * 100/sum(count))

mygrid <- ggplot(pct_quakes, aes(x = factor(1), y = pct, fill = era)) +
  scale_fill_manual(values = c("#999999", "#666666", "#333333", "#CC0000"),  guide = guide_legend(reverse = TRUE)) +
  geom_bar(width = 1, alpha = 0.6, stat = "identity", size = 0.2 ,
           aes(order = desc(era))) +
  geom_bar(data = filter(pct_quakes, STUSPS == 'OK'),
           alpha = 1.0,
           width = 1, stat = "identity", size = 0.2 , aes(order = desc(era))) +
  coord_polar(theta = "y") +
  facet_wrap(~ STUSPS, ncol = 4) +
  ggtitle("Earthquakes by time period for U.S. states with most overall earthquake activity")

mygrid + theme_dan_map()

```







----



## Nationwide quakes versus Oklahoma

Stacked charts


```{r}
# This manual creation of breaks is the least awkward way I know of creating a
# continuous scale from month-date and applying it to stat_bin for a more
# attractive graph
mbreaks <- as.numeric(seq(as.Date('2008-01-01'), as.Date('2015-08-01'), '1 month'))
states_quakes_ge_2008 <- filter(states_quakes, year >= 2008)

ggplot(data = states_quakes_ge_2008, aes(x = ceiling_date(time, 'month'), y = ..count..)) +
  stat_bin(aes(fill = !is_OK), breaks = mbreaks, position = "stack") +
  scale_x_date(breaks = date_breaks("year"), labels = date_format("%Y")) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("#FF6600", "gray"), labels = c("Oklahoma", "All other states")) +
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle("Monthly M3.0+ Earthquakes, Oklahoma vs. Other U.S. Combined")
```





Stacked chart by year

```{r, message = F}
ggplot(states_quakes, aes(x = factor(year))) +
  geom_histogram(aes(fill = !is_OK), binwidth = 1) +
  scale_fill_manual(values = c("#FF6600", "grey"),
                    labels = c('Oklahoma', 'All other U.S.')) +
  scale_x_discrete(breaks = pretty_breaks()) +
  scale_y_continuous(expand = c(0, 0)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle("Earthquakes in the U.S. by year since 2000, Oklahoma versus Others")
```

Stacked chart, ratio


```{r, message = F}
ggplot(states_quakes, aes(factor(year))) +
  geom_histogram(aes(fill = factor(ifelse(STUSPS == 'OK', 'OK', 'Other'))) , binwidth = 1, position = "fill") +
  scale_fill_manual(values = c("#FF6600", "grey")) +
  scale_x_discrete(breaks = pretty_breaks()) +
  scale_y_continuous(expand = c(0, 0)) +
  ggtitle("Earthquakes in the U.S. by year since 2005, Oklahoma versus Others")
```















<!--
To render this file:
library(rmarkdown)
setwd("~/Dropbox/rprojs/ok-earthquakes-Rnotebook/")

this_file <- 'chapter-3-exploring-historical-data.Rmd'
render(this_file, output_dir = './builds',
  html_document(toc = TRUE, self_contained = F, fig.path = 'figurines/'))

render(this_file, output_dir = './builds',
  md_document(variant = "markdown_github",
              preserve_yaml = TRUE))

-->



