---
title: "Chapter 3: Exploring the Historical Data"
author: "Dan Nguyen"
date: "August 17, 2015"
output:
  md_document:
    variant: markdown_github
---


## Setup

Load the libraries

```{r, echo = FALSE}
library(dplyr)
library(lubridate)
library(rgdal)
library(ggplot2)
library(grid)
library(RCurl)
setwd('/tmp')
```

Load the maps data.

```{r, message = FALSE}
fn <- 'cb_2014_us_state_5m'
zname <- paste(fn, '.zip', sep = '')
url <- paste("http://www2.census.gov/geo/tiger/GENZ2014/shp", zname, sep = '/')
if (!file.exists(zname)) download.file(url, zname)
unzip(zname, exdir = "shp")
us_map <- readOGR(paste('shp/', fn, '.shp', sep = ''), fn)
```

Remove all non-states including Washington D.C.:

```{r, message = FALSE}
non_states = c('DC', 'AS', 'GU', 'MP', 'PR', 'VI')
us_map <- subset(us_map, !(us_map$STUSPS %in% non_states))
```

Set up my visual themes:

```{r, message = FALSE}
map_theme <-  theme_minimal() + theme(
  axis.ticks = element_blank(),
  axis.text = element_blank(),
  axis.title = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_blank(),
  panel.margin = unit(0, "cm"),
  plot.margin = unit(c(0, 0, 0, 0), "cm"),
  legend.position = "right",
  legend.key.width = unit(0.1, 'cm'),
  legend.title = element_blank(),
  strip.text.x = element_text(size = rel(3.0))
)

bar_theme <-  theme_gray() + theme(
  axis.ticks = element_blank(),
  axis.title = element_blank(),
  axis.text = element_text(color = 'black'),
  axis.text.x = element_blank(),
  panel.background = element_rect(fill = "#EEEEEE"),
  panel.grid.major = element_line(size = 0.2, colour = "white", linetype = "solid"),
  plot.margin = unit(c(0, 0, 0, 0), "cm")
)
```


### Bulk loading the earthquakes data

![image](http://blog.danwin.com/images/posts/ok-earthquakes/usgs-map-ok-tx.jpg)

The form can be filled out like this:

http://earthquake.usgs.gov/earthquakes/search/

http://earthquake.usgs.gov/fdsnws/event/1/query.csv?


#### (╯°□°）╯ ┻DATA┻

Or if you don't want to go through the trouble of writing and running your own scraper, you can use the data that I've stored [at this URL](https://github.com/dannguyen/ok-earthquakes-RNotebook/raw/master/data/usgs-quakes-dump.csv.zip):

    https://github.com/dannguyen/ok-earthquakes-RNotebook/raw/master/data/usgs-quakes-dump.csv.zip


In the R script:

```{r}
fn <- 'usgs-quakes-dump.csv'
zname <- paste(fn, 'zip', sep = '.')
url <- paste("https://github.com/dannguyen/ok-earthquakes-RNotebook",
    "raw/master/data", zname, sep = '/')
if (!file.exists(zname)) download.file(url, zname, method = "libcurl")
unzip(zname, exdir="data")
usgs_data <- read.csv(paste('data', fn, sep = '/'), stringsAsFactors=FALSE)
```

Filter the data for just `earthquake`-type events with a magnitude of at least 2.0, then add a column for the `year` of the earthquake:

```{r}
quakes <- filter(usgs_data, type == 'earthquake', mag > 2.0) %>%
  mutate(year = year(time))
```

Count the number of quakes this data contains:

```{r}
nrow(quakes)
```

Visualize the count of earthquakes by year:

```{r}
ggplot(quakes, aes(x = as.character(year))) + 
  geom_histogram(binwidth = 1)  +
  geom_histogram(data=filter(quakes, year == 2014), binwidth = 1, fill="#990000") + 
  geom_histogram(data=filter(quakes, year == 2015), binwidth = 1, fill="gray") + 
  stat_bin( binwidth = 1, geom = "text",  aes(label = as.character(year), ymax = 1.05 * max(..count..)), vjust=-0.5, size = 3.5) + bar_theme 
```



Create a SpatialPointsDataFrame from quakes, then join it with `us_map` to add the `STUSGS` column:

```{r}
sp_quakes <- SpatialPointsDataFrame(data = quakes,
                                        coords = quakes[,c("longitude", "latitude")])
proj4string(sp_quakes) <- proj4string(us_map)
# create a temp variable
xdf <- over(sp_quakes, us_map[, 'STUSPS'])
sp_quakes$STUSPS <- xdf$STUSPS
# remove all rows from sp_quakes in which STUSPS is NA:
sp_quakes <- subset(sp_quakes, !is.na(sp_quakes$STUSPS))
us_quakes <- as.data.frame(sp_quakes)
```

How many quakes do we have left?

```{r}
nrow(us_quakes)
```

For U.S. quakes, what does the histogram look like?

```{r}
ggplot(us_quakes, aes(x = as.character(year))) + 
  geom_histogram(binwidth = 1)  +
  geom_histogram(data=filter(us_quakes, year == 2014), binwidth = 1, fill="#990000") + 
  geom_histogram(data=filter(us_quakes, year == 2015), binwidth = 1, fill="gray") + 
  stat_bin(
    data = filter(us_quakes, year %% 5 == 0 | year >= 2014),
    binwidth = 1, geom = "text",  aes(label = as.character(year), ymax = 1.05 * max(..count..)), vjust=-0.5, size = 3.5) + bar_theme 
```



For Oklahoma?

```{r}
ok_quakes <- filter(us_quakes, STUSPS == 'OK')
ggplot(ok_quakes, aes(x = as.character(year))) + 
  geom_histogram(binwidth = 1)  +
  geom_histogram(data=filter(ok_quakes, year == 2014), binwidth = 1, fill="#990000") + 
  geom_histogram(data=filter(ok_quakes, year == 2015), binwidth = 1, fill="gray") + 
  stat_bin(
    data = filter(ok_quakes, year %% 5 == 0 | year >= 2014),
    binwidth = 1, geom = "text",  aes(label = as.character(year), ymax = 1.05 * max(..count..)), vjust=-0.5, size = 3.5) + bar_theme + 
  ggtitle("Earthquakes by year in Oklahoma")
```


## Use small-multiples to do comparisons

But what if more than a few states have a large uptick in detected earthquakes in recent years? It could be that the USGS's equipment had a revolutionary advance in sensor technology. Or something globally catastrophic like Pacific Rim.

So we want to compare _histograms across different states_. Of course, we could just repeat the above steps for each state as we did for Oklahoma. But ggplot has the `facet_wrap()` function that can do this repetitive charting and assemble the resulting charts into a nice grid.

It's as easy as taking the exact same charting code and then adding a `facet_wrap()` call:

```{r}
top_states = group_by(us_quakes, STUSPS) %>% 
      summarise(count = n()) %>%
      arrange(desc(count)) %>%
      head(9)
top_states_quakes <- filter(us_quakes, STUSPS %in% top_states$STUSPS )
g <- ggplot(top_states_quakes, aes(x = as.character(year))) + 
  geom_histogram(binwidth = 1, fill = "#999999")  +
  geom_histogram(data=filter(top_states_quakes, year >= 2012), binwidth = 1, fill="#990000") + 
  geom_histogram(data=filter(top_states_quakes, year == 2015), binwidth = 1, fill="#BB9999")

g + facet_wrap(~ STUSPS, ncol = 3)  + bar_theme 
```


It's not even close.


```{r}
g + scale_y_log10() + facet_wrap(~ STUSPS, ncol = 3)  + bar_theme 
```




```{r}
ok_quakes <- filter(us_quakes, STUSPS == 'OK')
ggplot(ok_quakes, aes(x = as.character(year), 
                      fill = factor(ifelse(year >= 2012, 'A', 
                                            ifelse(year >= 2005, 'B', 'C')
                                           )
                                  )
                      )) +                                                   
  geom_histogram(binwidth = 1)  
```


Pie:

```{r}
ok_quakes <- filter(us_quakes, STUSPS == 'OK')
ggplot(ok_quakes, aes(x = factor(1), 
                      fill = factor(ifelse(year >= 2012, 'A', 
                                            ifelse(year >= 2005, 'B', 'C')
                                           )
                                  )
                      )) +
  geom_bar(width = 1) + 
  geom_histogram(binwidth = 1)  + coord_polar(theta = "y") + map_theme 
```




Line:



```{r}
ok_quakes <- filter(us_quakes, STUSPS == 'OK')
ggplot(ok_quakes, aes(x = factor(1), 
                      fill = factor(ifelse(year >= 2012, 'A', 
                                            ifelse(year >= 2005, 'B', 'C')
                                           )
                                  )
                      )) +
  geom_bar(width = 1) + 
  geom_histogram(binwidth = 1)  + coord_polar(theta = "y") + map_theme 
```


Multipie: (DOESNTWORK)

```{r}

ggplot(top_states_quakes, aes(
                      x = factor(1), 
                      fill = factor(ifelse(year >= 2012, 'A', 
                                            ifelse(year >= 2005, 'B', 'C')
                                           )
                                  )
                      )) +
  geom_bar(width = 1) + 
  geom_histogram(binwidth = 1, aes(y = ..density..))  + coord_polar(theta = "y") + 

  facet_wrap(~ STUSPS, ncol = 3)  + map_theme
```



Grouped bar chart

```{r}
ggplot(top_states_quakes, 
       aes(x = year, fill = STUSPS)) +  
  geom_histogram(binwidth = 1)
```


Proportional stacked bar graph


```{r}
zztop <- mutate(top_states_quakes, era = cut(year, 5, labels = cut(year, 5, include.lowest = T)))
gzztop <- group_by(zztop, era, STUSPS) %>% summarise(counts = length(STUSPS)) %>%
  group_by(STUSPS) %>% mutate(pct = counts * 100/ sum(counts))

ggplot(gzztop, aes(x = STUSPS,  fill = era, y = pct)) + geom_bar(stat = "identity")
```


NOW let's do pie charts


```{r}

ggplot(gzztop, aes(x = factor(1), y = pct, fill = era)) +
  scale_fill_manual(values = c("gray", "gray", "gray", "gray", "red")) + 
  geom_bar(width = 1, stat = "identity", size = 0.2 , aes(order = desc(era))) + 
  coord_polar(theta = "y") +
  facet_wrap(~ STUSPS, ncol = 3)  + map_theme
```


A better grouped chart

```{r}
ggplot(top_states_quakes, 
       aes(x = STUSPS, 
       order = desc(ifelse(year < 2012,  '1995 - 2011', '2012 - 2015')),      
       fill = ifelse(year < 2012,  '1995 - 2011', '2012 - 2015'))) +  
  geom_histogram(binwidth = 1)
```

How to show this proprtional to years though?


```{r}
ggplot(top_states_quakes, 
       aes(x = STUSPS, fill = factor(year), order = desc(year) 
           
        
           )) + scale_fill_brewer() + 
      
  geom_histogram(binwidth = 1, color = 'black', ))
```
