---
title: "Chapter 4: Correlations and Limitations"
author: "Dan Nguyen"
date: "August 17, 2015"
output:
  md_document:
    variant: markdown_github
---

<span id="chapter-4-mark"></span>

# Chapter 4: Correlation, limitations, and known unknowns


Questions to answer:
- What are the geospatial characteristics of the recent Earthquakes?
- Is the recent spurt of earthquakes located in one area?
- What is the correlation between well activity and earthquakes?


## Setup


- [readxl](https://github.com/hadley/readxl) - Later on we'll need to read from an XLS file. Again, via Hadley Wickham.



```{r, warning = F, message = FALSE}
# Load libraries
library(ggplot2)
library(grid)
library(gridExtra)
library(dplyr)
library(lubridate)
library(rgdal)
library(readxl)
library(scales)
library(ggmap)
# load my themes:
source("./myslimthemes.R")
theme_set(theme_dan())

# create a data directory
dir.create('./data')

```

Download the map data as before:

```{r, warning = F, message = F, results = "hide"}
fname <- "./data/cb_2014_us_state_20m.zip"
if (!file.exists(fname)){
  url <- "http://www2.census.gov/geo/tiger/GENZ2014/shp/cb_2014_us_state_20m.zip"
  print(paste("Downloading: ", url))
  download.file(url, fname)
}
unzip(fname, exdir = "./data/shp")
#
# Read the map data
us_map <- readOGR("./data/shp/cb_2014_us_state_20m.shp", "cb_2014_us_state_20m")
states_map <- us_map[!us_map$STUSPS %in%
                        c('AS', 'DC', 'GU', 'MP', 'PR', 'VI'),]

```


Download and read the quakes data as before:


```{r, warning = F, message = F}
fn <- './data/usgs-quakes-dump.csv'
zname <- paste(fn, 'zip', sep = '.')
if (!file.exists(zname) || file.size(zname) < 2048){
  url <- paste("https://github.com/dannguyen/ok-earthquakes-RNotebook",
    "raw/master/data", zname, sep = '/')
  print(paste("Downloading: ", url))
  # note: if you have problems downloading from https, you might need to include
  # RCurl
  download.file(url, zname, method = "libcurl")
}
unzip(zname, exdir="data")
# read the data into a dataframe
usgs_data <- read.csv(fn, stringsAsFactors = FALSE)
```

Filter and mutate the data

```{r, warning = F, message = F}
# Remove all non earthquakes and events
# with magnitude less than 3.0:
quakes <- usgs_data %>% filter(mag >= 3.0, type == 'earthquake')

quakes$time <- as.Date(quakes$time)
quakes$year <- year(quakes$time)
quakes <- mutate(quakes, era = ifelse(year <= 2000, "1995-2000",
          ifelse(year <= 2005, "2001-2005",
          ifelse(year <= 2010, "2006-2010", "2011-2015"))))
```

```{r, warning = F, message = F}
sp_quakes <- SpatialPointsDataFrame(data = quakes,
                coords = quakes[,c("longitude", "latitude")])
sp_quakes@proj4string <- states_map@proj4string
# subset for earthquakes in the U.S.
xdf <- over(sp_quakes, states_map[, 'STUSPS'])
states_quakes <- cbind(sp_quakes, xdf) %>% filter(!is.na(STUSPS))
# add a convenience column for Oklahoma:
states_quakes <- mutate(states_quakes, is_OK = STUSPS == 'OK')
```



## Mapping the quakes


For mapping purposes, we'll make a contiguous-states only. Remember in the previous chapter, we saw how Oklahoma's recent earthquake activity outpaced all of the U.S., including Alaska and Hawaii. And more importantly, remember that I don't know how to transpose Alaska and Hawaii neatly on to an Albers projection:

```{r, warning = F, message = F}
cg_map <- states_map[!states_map$STUSPS %in% c('AK', 'HI'), ]
cg_quakes <- states_quakes[!states_quakes$STUSPS  %in% c('AK', 'HI'), ]
```

Trying to map all the quakes leads to the unavoidable problem of overplotting:

```{r, earthquakes_by_era_since_1995_overplotted, warning = F, message = F}
ggplot() +
  geom_polygon(data = cg_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = cg_quakes, aes(x = longitude, y = latitude), shape = 1, color = "red", alpha = 0.2) +
  coord_map("albers", lat0 = 38, latl = 42) +
  theme_dan_map() +
  ggtitle("M3.0+ earthquakes in U.S. since 1995")

```


By era:

Legend hack: http://stackoverflow.com/questions/5290003/how-to-set-legend-alpha-with-ggplot2

```{r, earthquakes_by_era_since_1995_plotted_by_era, warning = F, message = F}
ggplot() +
  geom_polygon(data = cg_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = cg_quakes, aes(x = longitude, y = latitude, color = era), shape = 4,  alpha = 0.2) +
  coord_map("albers", lat0 = 38, latl = 42) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_dan_map() +
  ggtitle("M3.0+ earthquakes in U.S. since 1995")

```

Small multiples:

```{r, small_multiples_earthquakes_by_era_since_1995, warning = F, message = F}
ggplot() +
  geom_polygon(data = cg_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = cg_quakes, aes(x = longitude, y = latitude), shape = 4,  alpha = 0.2, color = "red") +
  coord_map("albers", lat0 = 38, latl = 42) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_dan_map() +
  facet_wrap(~ era) +
  ggtitle("M3.0+ earthquakes in U.S. by time period")
```

Small multiples focused on Oklahoma:

```{r, small_multiples_OK_only, warning = F, message = F}
# Dataframe of just Oklahoma quakes:
ok_quakes <- filter(states_quakes, is_OK)
# map of just Oklahoma state:
ok_map <- states_map[states_map$STUSPS == 'OK',]
```

```{r, small_multiples_oklahoma_map_quakes, fig.cap = "Small Multiples Oklahoma"}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = ok_quakes, aes(x = longitude, y = latitude), shape = 4,  alpha = 0.5, color = "red") +
  coord_map("albers", lat0 = 38, latl = 42) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_dan_map() +
  facet_wrap(~ era) +
  ggtitle("M3.0+ earthquakes in Oklahoma by time period")
```













## Injection volumes

Download # http://www.occeweb.com/og/ogdatafiles2.htm


2013:

```{r, warning = F, message = F}
fname <- "./data/2013_UIC_Injection_Volumes_Report.xlsx"
if (!file.exists(fname)){
  url <- "http://www.occeweb.com/og/2013%20UIC%20Injection%20Volumes%20Report.xlsx"
  print(paste("Downloading: ", url))
  download.file(url, fname)
}
injections_data_2013 <- read_excel(fname)
injections_2013 <-  injections_data_2013 %>%
    mutate(Volume = as.numeric(Volume),
           API = as.character(API), ReportYear = as.numeric(ReportYear)) %>%
    # filter out rows with missing Volume or erroneous X/Y
    filter(!is.na(Volume),
           !is.na(X), X != 0,  X < -90, X > -100,
           !is.na(Y), Y != 0, Y > 33.5, Y < 40)
```


Aggregate the wells by their unique identifier and create a `total_volume` column:


```{r, warning = F, message = F}
wells_2013 <-   group_by(injections_2013, ReportYear, API, X, Y) %>%
    summarise(total_volume = sum(Volume))
```



Note that there is 2012 UIC data. However, this data does _not_ have X/Y coordinate data.


```{r}
fname <- "./data/2012_UIC_Injection_Volumes_Report.xlsx"
if (!file.exists(fname)){
  url <- "http://www.occeweb.com/og/2012Injections20141029.xlsx"
  print(paste("Downloading: ", url))
  download.file(url, fname)
}
tdf  <- read_excel(fname)
injections_data_2012 <- tdf[, colSums(is.na(tdf)) != nrow(tdf)] %>%
    mutate(Volume = as.numeric(Volume),
          API = as.character(API), ReportYear = as.numeric(ReportYear)) %>%
    filter(!is.na(Volume))
```

Do a join:

```{r}
wells_2012 <- injections_data_2012 %>%
  left_join(select(as.data.frame(wells_2013), API, X, Y), by = 'API') %>%
  group_by(API, X, Y, ReportYear) %>%
  summarise(total_volume = sum(Volume))
```


#### 2011

```{r}
fname <- "./data/2011_UIC_Injection_Volumes_Report.xlsx"
if (!file.exists(fname)){
  url <- "http://www.occeweb.com/og/2011INJECTIONVOLUMES.xlsx"
  print(paste("Downloading: ", url))
  download.file(url, fname)
}
tdf <- read_excel(fname)
# remove NA columns http://stackoverflow.com/questions/15968494/how-to-delete-columns-with-na-in-r
injections_data_2011 <- tdf[, colSums(is.na(tdf)) != nrow(tdf)] %>%
    mutate(Volume = as.numeric(Volume),
           API = as.character(API), ReportYear = as.numeric(ReportYear)) %>%
    filter(!is.na(Volume))

wells_2011 <- injections_data_2011 %>%
  left_join(select(as.data.frame(wells_2013), API, X, Y), by = 'API') %>%
  group_by(API, X, Y, ReportYear) %>%
  summarise(total_volume = sum(Volume))

```

"All UIC 1012A Reports" data


```{r}
fname <- "./data/all_2006-2010uic_1012a.xls"
if (!file.exists(fname)){
  url <- "http://www.occeweb.com/og/all_2006-2010uic_1012a.xls"
  print(paste("Downloading: ", url))
  download.file(url, fname)
}
tdf <- read_excel(fname)
# remove NA columns http://stackoverflow.com/questions/15968494/how-to-delete-columns-with-na-in-r
# the column names are very screwed up
names(tdf) <- c('API_COUNTY', 'API', 'LEASE_NAME', 'WELL_NUMBER', 'Y', 'X', 'YEAR', 'FLUID_TYPE', 'PACKERDPTH', 'total_volume')

injections_data_2006_2010 <- tdf[, colSums(is.na(tdf)) != nrow(tdf)] %>%
    mutate(total_volume = as.numeric(total_volume),
           API = as.character(API), ReportYear = as.numeric(YEAR),
           X = as.numeric(X), Y = as.numeric(Y)
           ) %>%
    filter(!is.na(total_volume),
           ReportYear <= 2010,
           !is.na(X), X != 0,  X < -90, X > -100,
           !is.na(Y), Y != 0, Y > 33.5, Y < 40)

wells_2006_2010 <- select(injections_data_2006_2010, API, ReportYear, X, Y, total_volume)

```


```{r}
all_wells <- bind_rows(wells_2013, wells_2012, wells_2011, wells_2006_2010) %>%
  filter(!is.na(X))
```


Histograms:



```{r}
ggplot(data = group_by(all_wells, ReportYear) 
       %>% summarize(total = sum(total_volume)), 
       aes(x = ReportYear, y = total)) + geom_bar(stat = 'identity')
```

Summarise by location


```{r}
q1 <- ggplot(data = all_wells %>%
         group_by(Y, ReportYear) %>% summarize(total = sum(total_volume)), 
       aes(x = factor(ReportYear), y = total, order = desc(Y >= 36.5), 
           fill = Y >= 36.5)) + geom_bar(stat = 'identity') +
        scale_fill_manual(values = c("gray", "#FF6600"), labels = c("Below 36.5", "Above 36.5")) +
      guides(fill = guide_legend(reverse = F)) 
```


Histogram of quakes

```{r}
q2 <- ggplot(data = filter(ok_quakes, year >= 2007, year <= 2014), 
       aes(x = factor(year), order = desc(latitude >= 36.5),
           fill = latitude >= 36.5)) + geom_histogram(binwidth = 1) +
        scale_fill_manual(values = c("gray", "#FF6600"), labels = c("Below 36.5", "Above 36.5")) +
      guides(fill = guide_legend(reverse = F)) 
```


```{r}
grid.arrange(
  q1 + theme(axis.text.y = element_blank()), 
  q2 + theme(axis.text.y = element_blank()))
```






Facet wrap the wells:

```{r}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  geom_point(data = filter(all_wells, total_volume <= 360000),
             aes(x = X, y = Y),
             alpha = 0.3, shape = 1, color = 'yellow') +
  geom_point(data = filter(all_wells, total_volume >= 360000),
             aes(x = X, y = Y),
             alpha = 0.3, shape = 1, color = 'purple') +
  # geom_point(data = filter(ok_quakes, year >= 2012), aes(x = longitude, y = latitude),
  #           alpha = 0.1, shape = 1, color = 'red') +
  coord_map("albers", lat0 = 38, latl = 42) + theme_dan_map() +
  ggtitle("2013 UIC and quakes")  +
  facet_wrap(~ ReportYear, ncol = 2)
```

TODO: Hexbin them


Counts:

```{r}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +

  stat_binhex(data = all_wells, aes(x = X, y = Y, alpha = ..count..), bins = 30 ) +
  coord_equal() + 
  theme_dan_map() +
  facet_wrap(~ ReportYear, ncol = 2)
```


Volume



```{r}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  stat_summary_hex(data = all_wells, 
                   aes(x = X, y = Y, z = total_volume), 
                   bins = 30, 
                   fun = function(z){ sum(z) },
                   color = 'white') +
  scale_fill_gradientn(colours = c("#DDDDEC", "purple"), na.value = NA) + 
  
  coord_equal() + 
  theme_dan_map() +
  facet_wrap(~ ReportYear, ncol = 1)
```



Hi-lo pass:

```{r}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  stat_summary_hex(data = all_wells, 
                   aes(x = X, y = Y, z = total_volume), 
                   bins = 30, 
                   fun = function(z){
                     sz <- min(sum(z), 60000000)
                     ifelse(sz > 10000000, sz, NA)
                    }, 
                   color = 'white', drop = TRUE ) +
  scale_fill_gradientn(colours = c("#DDDDEC", "purple"), na.value = NA) + 
  
  coord_equal() + 
  theme_dan_map() +
  facet_wrap(~ ReportYear, ncol = 1)
```


Do side by side facet of earthquakes


```{r}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  stat_binhex(data = filter(ok_quakes, year >= 2012, year <= 2014), 
              aes(x = longitude, y = latitude), bins = 30, color = "#FFFFFF") +
  scale_fill_gradient(low = "#ECDDDD", high = "red") + 
  coord_equal() + 
  theme_dan_map() +
  facet_wrap(~ year, ncol = 1)
```



-------------
Map it: (TODO: Delete these)


```{r, warning = F, message = F}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  geom_point(data = filter(wells_2013, total_volume <= 360000),
             aes(x = X, y = Y),
             alpha = 0.3, shape = 1, color = 'yellow') +
  geom_point(data = filter(wells_2013, total_volume >= 360000),
             aes(x = X, y = Y),
             alpha = 0.3, shape = 1, color = 'purple') +
  geom_point(data = filter(ok_quakes, year >= 2012), aes(x = longitude, y = latitude),
            alpha = 0.1, shape = 1, color = 'red') +
  coord_map("albers", lat0 = 38, latl = 42) + theme_dan_map() +
  ggtitle("2013 UIC and quakes")  +
  facet_wrap(~ year, ncol = 1)
```


```{r, warning = F, message = F}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  geom_point(data = filter(wells_2012, total_volume < 360000),
             aes(x = X, y = Y),
             alpha = 0.3, shape = 1, color = 'yellow') +
  geom_point(data = filter(wells_2012, total_volume >= 360000),
             aes(x = X, y = Y),
             alpha = 0.3, shape = 1, color = 'purple') +
  geom_point(data = filter(ok_quakes, year >= 2012), aes(x = longitude, y = latitude),
            alpha = 0.1, shape = 1, color = 'red') +

  coord_map("albers", lat0 = 38, latl = 42) + theme_dan_map() +
  ggtitle("2012 UIC and quakes") +
  facet_wrap(~ year, ncol = 1)
```


2011 map:


```{r, warning = F, message = F}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  geom_point(data = filter(wells_2011, total_volume < 360000),
             aes(x = X, y = Y),
             alpha = 0.3, shape = 1, color = 'yellow') +
  geom_point(data = filter(wells_2011, total_volume >= 360000),
             aes(x = X, y = Y),
             alpha = 0.3, shape = 1, color = 'purple') +
  geom_point(data = filter(ok_quakes, year >= 2012), aes(x = longitude, y = latitude),
            alpha = 0.1, shape = 1, color = 'red') +

  coord_map("albers", lat0 = 38, latl = 42) + theme_dan_map() +
  ggtitle("2011 UIC and quakes") +
  facet_wrap(~ year, ncol = 1)
```


## Maps


TK: Justify the use of Hexbin map, similar to binning by year instead of day


Hexbin map without projection

Earthquakes:

```{r, warning = F, message = F}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  stat_binhex(data = ok_quakes, aes(x = longitude, y = latitude, alpha = ..count..), bins = 30 ) +
  scale_fill_gradientn(colours=c("white","red")) +
  coord_equal() +
  theme_dan_map()
```



TK: http://stackoverflow.com/questions/13167531/ggplot2-multiple-stat-binhex-plots-with-different-color-gradients-in-one-image

overlay of injections and earthquakes


```{r, warning = F, message = F}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  stat_summary_hex(data = wells_2013, aes(x = X, y = Y, z = total_volume), bins = 30 ) + scale_fill_gradientn(colours=c("white","green")) +
  stat_binhex(data = ok_quakes, aes(x = longitude, y = latitude, alpha = ..count..), bins = 30 ) +

  coord_equal() +
  theme_dan_map()
```




Hexbin map with injections
```{r, warning = F, message = F}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  stat_summary_hex(data = wells_2013, aes(x = X, y = Y, z = total_volume), alpha = 0.9, bins = 20 ) +
  geom_point(data = ok_quakes, aes(x = longitude, y = latitude),
           alpha = 0.1, size = 0.2, shape = 1, color = 'red')

```




-------------


```{r, warning = F, message = F}

sp_ok_quakes <- SpatialPointsDataFrame(data = ok_quakes,
                          coords = ok_quakes[,c("longitude", "latitude")])
proj4string(sp_ok_quakes) <- proj4string(ok_map)

sp_wells_2013 <- SpatialPointsDataFrame(data = wells_2013,
                          coords = wells_2013[,c("X", "Y")])

proj4string(sp_wells_2013) <- proj4string(ok_map)

albers_crs <- CRS("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs")
ok_map.albers <- spTransform(ok_map, albers_crs)
ok_quakes.albers <- as.data.frame(spTransform(sp_ok_quakes, albers_crs))
wells_2013.albers <- as.data.frame(spTransform(sp_wells_2013, albers_crs))

###0-----------
# look ma, no coord_map
ggplot() +
  geom_polygon(data = ok_map.albers, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  geom_point(data = filter(wells_2013.albers, total_volume < 300000),
             aes(x = X.1, y = Y.1),
             alpha = 0.3 , color = 'green', size = 0.4, shape = 1) +
  geom_point(data = filter(wells_2013.albers, total_volume >= 300000),
             aes(x = X.1, y = Y.1),
             alpha = 0.3 , color = 'yellow', size = 1, shape = 1) +

  geom_point(data = ok_quakes.albers, aes(x = longitude.2, y = latitude.2),
            alpha = 0.3, size = 1, shape = 1, color = 'red') +
  theme_dan_map()
```

Small multiples


```{r}
ggplot() +
  geom_polygon(data = ok_map.albers, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  geom_point(data = filter(wells_2013.albers, total_volume < 300000),
             aes(x = X.1, y = Y.1),
             alpha = 0.3 , color = 'green', size = 0.4, shape = 1) +
  geom_point(data = filter(wells_2013.albers, total_volume >= 300000),
             aes(x = X.1, y = Y.1),
             alpha = 0.3 , color = 'yellow', size = 1, shape = 1) +

  geom_point(data = filter(ok_quakes.albers, year >= 2013), aes(x = longitude.2, y = latitude.2),
            alpha = 0.3, size = 1, shape = 1, color = 'red') +
  theme_dan_map() + facet_wrap(~ year, ncol = 1)
```




# Gas prices

https://research.stlouisfed.org/fred2/series/DCOILWTICO/downloaddata


```{r, warning = F, message = F}
fname <- './data/stlouisfed-oil-prices.csv'
if (!file.exists(fname)){
  curlstr <- paste("curl -s --data 'form%5Bnative_frequency%5D=Daily&form%5Bunits%5D=lin&form%5Bfrequency%5D=Daily&form%5Baggregation%5D=Average&form%5Bobs_start_date%5D=1986-01-02&form%5Bobs_end_date%5D=2015-08-24&form%5Bfile_format%5D=csv&form%5Bdownload_data_2%5D='", '-o', fname)
  print(paste("Downloading: ", fname))
  system(curlstr)
}
gasdata <- read.csv("./data/stlouisfed-oil-prices.csv", stringsAsFactors = F) %>%
  filter(year(DATE) >= 2008, VALUE != '.')  %>%
  mutate(week = floor_date(as.Date(DATE), 'week'), VALUE = as.numeric(VALUE), panel = "GAS") %>%
  group_by(week) %>% summarize(avg_value = mean(VALUE))


```







```{r, warning = F, message = F}
okquakes_weekly <- mutate(ok_quakes, week = floor_date(time, 'week'), panel = 'Quakes') %>%
  filter(year(time) >= 2008) %>%
  group_by(week) %>%
  summarize(count = n())


gp <- ggplot() + scale_x_date(breaks = pretty_breaks(),
                              limits = c(as.Date('2008-01-01'), as.Date('2015-08-31')))

quakesg <- gp + geom_bar(data = okquakes_weekly, aes(x = week, y = count), stat = "identity", position = 'identity', color = 'black') +
  scale_y_continuous(expand = c(0, 0)) +
  ggtitle("Weekly Counts of M3.0+ Earthquakes in Oklahoma")

gasg <- gp + geom_line(data = gasdata, aes(x = week, y = avg_value), size = 0.5, color = 'black') +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 150)) +
  ggtitle("Weekly Average Oil Prices, Dollars per Barrel")
```


```{r, warning = F, message = F}
# http://stackoverflow.com/questions/10197738/add-a-footnote-citation-outside-of-plot-area-in-r

annotations <- list(
  list(date = "2011-11-05", label = "5.6M earthquake hits Oklahoma", letter = 'A'),
  list(date = "2014-02-18", label = 'OGS states that "Overall, the majority, but not all, of the recent earthquakes appear\nto be the result of natural stresses."', letter = 'B'),
  list(date = "2015-04-21", label = 'OGS reverses its opinion: "The rates and trends in seismicity are very unlikely\nto represent a naturally occurring process"', letter = 'C')
)


datelines <- lapply(annotations, function(a){
  wk <- as.numeric(floor_date(as.Date(a$date), 'week'))
  geom_vline(xintercept = wk, color = "red",
             linetype = 'dashed')
})

datelabels <- lapply(annotations, function(a){
  dt <- as.Date(a$date)
  annotate("text", x = dt, y = Inf, size = rel(4.0),  label = a$letter, vjust = 1.0, fontface = 'bold', color = "red", hjust = 1.5)
})

ttheme <- theme(plot.title = element_text(size = 12))

footnotes = paste(lapply(annotations, function(a){
              paste(a$letter,
              paste(strftime(a$date, '%b %d, %Y'), a$label, sep = ' - '),
              sep = '. ')
    }),
  collapse = '\n')

p <- arrangeGrob(quakesg + datelines + datelabels + ttheme,
                 gasg + datelines + datelabels + ttheme,
                 bottom = textGrob(label = footnotes, x = unit(1, 'cm'),
                                         hjust = 0.0, vjust = 0.3,
                                         gp = gpar(fontsize = rel(10), fontfamily = "Gill Sans MT"))
                 )

plot.new()
grid.draw(p)
```




The study, titled "Oklahoma's Recent Earthquakes and Saltwater Disposal," was funded by the Stanford Center for Induced and Triggered Seismicity, an affiliate program at the School of Earth, Energy & Environmental Sciences.


> Active faults in Oklahoma might trigger an earthquake every few thousand years. However, by increasing the fluid pressure through disposal of wastewater into the Arbuckle formation in the three areas of concentrated seismicity – from about 20 million barrels per year in 1997 to about 400 million barrels per year in 2013 – humans have sped up this process dramatically. "The earthquakes in Oklahoma would have happened eventually," Walsh said. "But by injecting water into the faults and pressurizing them, we've advanced the clock and made them occur today."



http://news.stanford.edu/news/2015/june/okla-quake-drilling-061815.html



## Trying Google Maps


```{r, warning = F, message = F}
library(ggmap)
ok_goog_map <- get_googlemap(center = c(lon = -99.007, lat = 35.38905),  size = c(450,250), zoom = 6, scale = 2, maptype = 'hybrid',
style = c(feature = "administrative.province", element = "labels", visibility = "off"))
```

With points

```{r, warning = F, message = F}
ggmap(ok_goog_map, extent = 'panel') +
  geom_point(data = ok_quakes, aes(x = longitude, y = latitude), alpha = 0.2, shape = 4, colour = "red")
```


With hexbin:

```{r, warning = F, message = F}
ggmap(ok_goog_map, extent = 'panel') +
  stat_binhex(data = ok_quakes, aes(x = longitude, y = latitude, alpha = ..count..), bins = 30 ) +
  scale_fill_gradientn(colours=c("white","red")) +
  guides(alpha = FALSE)
```


Focus on Oklahoma City area:


```{r, warning = F, message = F}
okcity_goog_map  <- get_googlemap(center = c(lon = -97.437287, lat = 36.1815),  size = c(640,640), zoom = 9, scale = 2, maptype = 'hybrid',
style = c(feature = "administrative.province", element = "labels", visibility = "off"))

```

Hexbin
```{r, warning = F, message = F}
ggmap(okcity_goog_map) +
  stat_binhex(data = ok_quakes, aes(x = longitude, y = latitude, color = ..count..), bins = 30, fill = NA, alpha = 0.5 ) +
  scale_color_gradientn(colours=c("white","red")) +
  guides(fill = FALSE) + theme_dan_map()

```


----------------

Volumes on monthly

http://advances.sciencemag.org/content/1/5/e1500195.figures-only

```{r}
wells_by_month <- mutate(injections_2013, had_30k_month = Volume >= 30000) %>%
            group_by(API, had_30k_month, X, Y) %>% summarise()

```

```{r}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  geom_point(
    data = filter(wells_by_month, !had_30k_month),
    aes(x = X, y = Y), shape = 1, color = "yellow", alpha = 0.2) +
  geom_point(
    data = filter(wells_by_month, had_30k_month),
    aes(x = X, y = Y), shape = 1, color = "purple", alpha = 0.4) +
  geom_point(
    data = filter(ok_quakes, year >= 2013),
    aes(x = longitude, y = latitude), shape = 1, color = "green", alpha = 0.3) +
  coord_map("albers", lat0 = 38, latl = 42) +
  theme_dan_map()
```




------




## Things TODO

- Use USGS Geologic map data: https://mrdata.usgs.gov/geology/state/state.php?state=OK



Reference to disposal wells in OK gov:

http://earthquakes.ok.gov/what-we-know/earthquake-map/


On April 21, earthquakes.ok.gov was launched:

http://earthquakes.ok.gov/news/



## The state of research

[NPR's Oklahoma StateImpact project has a nice reading list](https://stateimpact.npr.org/oklahoma/2015/05/05/stateimpacts-earthquake-research-reading-list/), and so does the state of Oklahoma on [earthquakes.ok.gov](http://earthquakes.ok.gov/what-we-know/academic-research/). Much of what I include below is cribbed from those collections:


-  [Texas Railroad Commission Refutes Study Linking Quakes to Oil and Gas Industry](https://stateimpact.npr.org/texas/2015/09/02/texas-railroad-commission-refutes-study-linking-quakes-to-oil-and-gas-industry/)



http://www.newyorker.com/magazine/2015/04/13/weather-underground


> Holland had been clear about the connections between disposal wells and earthquakes, and during the socializing a researcher from Princeton observed that Holland’s position seemed to have shifted from that represented in O.G.S. statements. “Let me think how I can answer that while there’s a reporter standing right there,” Holland said, lightly. “The O.G.S. is a nonacademic department of a state university that, like many state universities, doesn’t get that much funding from the state.” The O.G.S. is part of O.U.’s Mewbourne College of Earth and Energy, which also includes the ConocoPhillips School of Geology and Geophysics. About seventeen per cent of O.U.’s budget comes from the state. “I prepare twenty pages for those statements and what comes out is one page. Those are not necessarily my words.”


In Science Magazine ("[High-rate injection is associated with the increase in U.S. mid-continent seismicity](https://profile.usgs.gov/myscience/upload_folder/ci2015Jun1814143055600Weingarten_etal.pdf)"), USGS scientists assert that "the entire increase in earthquake rate is associated with fluid injection wells."


[High-rate injection is associated with the increase in U.S. mid-continent seismicity
](http://www.sciencemag.org/content/348/6241/1336)

> Wastewater injection wells induce earthquakes that garner much attention, especially in tectonically inactive regions. Weingarten et al. combined information from public injection-well databases from the eastern and central United States with the best earthquake catalog available over the past 30 years. The rate of fluid injection into a well appeared to be the most likely decisive triggering factor in regions prone to induced earthquakes. Along these lines, Walsh III and Zoback found a clear correlation between areas in Oklahoma where waste saltwater is being injected on a large scale and areas experiencing increased earthquake activity.


[Oklahoma’s recent earthquakes and saltwater disposal](http://advances.sciencemag.org/content/1/5/e1500195.article-info) - F. Rall Walsh III and Mark D. Zoback

> Over the past 5 years, parts of Oklahoma have experienced marked increases in the number of small- to moderate-sized earthquakes. In three study areas that encompass the vast majority of the recent seismicity, we show that the increases in seismicity follow 5- to 10-fold increases in the rates of saltwater disposal. Adjacent areas where there has been relatively little saltwater disposal have had comparatively few recent earthquakes. In the areas of seismic activity, the saltwater disposal principally comes from “produced” water, saline pore water that is coproduced with oil and then injected into deeper sedimentary formations. These formations appear to be in hydraulic communication with potentially active faults in crystalline basement, where nearly all the earthquakes are occurring. Although most of the recent earthquakes have posed little danger to the public, the possibility of triggering damaging earthquakes on potentially active basement faults cannot be discounted.

TK img: http://d3a5ak6v9sb99l.cloudfront.net/content/advances/1/5/e1500195/F1.large.jpg?download=true


TK img: http://d3a5ak6v9sb99l.cloudfront.net/content/advances/1/5/e1500195/F2.large.jpg?width=800&height=600&carousel=1


- [Sharp increase in central Oklahoma seismicity since 2008 induced by massive wastewater injection](http://www.sciencemag.org/content/345/6195/448)



> Unconventional oil and gas production provides a rapidly growing energy source; however, high-production states in the United States, such as Oklahoma, face sharply rising numbers of earthquakes. Subsurface pressure data required to unequivocally link earthquakes to wastewater injection are rarely accessible. Here we use seismicity and hydrogeological models to show that fluid migration from high-rate disposal wells in Oklahoma is potentially responsible for the largest swarm. Earthquake hypocenters occur within disposal formations and upper basement, between 2- and 5-kilometer depth. The modeled fluid pressure perturbation propagates throughout the same depth range and tracks earthquakes to distances of 35 kilometers, with a triggering threshold of ~0.07 megapascals. Although thousands of disposal wells operate aseismically, four of the highest-rate wells are capable of inducing 20% of 2008 to 2013 central U.S. seismicity.


- [Myths and Facts on Wastewater Injection, Hydraulic Fracturing, Enhanced Oil Recovery, and Induced Seismicity](http://srl.geoscienceworld.org/content/86/4/1060.full)



- [Observations of static Coulomb stress triggering of the November 2011 M5.7 Oklahoma earthquake sequence](http://onlinelibrary.wiley.com/doi/10.1002/2013JB010612/abstract)
