---
title: "Chapter 4: Correlations and Limitations"
author: "Dan Nguyen"
date: "August 17, 2015"
output:
  md_document:
    variant: markdown_github
---

<span id="chapter-4-mark"></span>

# Chapter 4: Correlations and Limitations


Questions to answer:
- What are the geospatial characteristics of the recent Earthquakes?
- Is the recent spurt of earthquakes located in one area?
- What is the correlation between well activity and earthquakes?


## Setup


- [readxl](https://github.com/hadley/readxl) - Later on we'll need to read from an XLS file. Again, via Hadley Wickham.



```{r, warning = F, message = FALSE}
# Load libraries
library(ggplot2)
library(grid)
library(gridExtra)
library(dplyr)
library(lubridate)
library(rgdal)
library(readxl)
library(scales)
library(ggmap)
# load my themes:
source("./myslimthemes.R")
theme_set(theme_dan())

# create a data directory
dir.create('./data')

```

Download the map data as before:

```{r, warning = F, message = F}
fname <- "./data/cb_2014_us_state_20m.zip"
if (!file.exists(fname)){
  url <- "http://www2.census.gov/geo/tiger/GENZ2014/shp/cb_2014_us_state_20m.zip"
  print(paste("Downloading: ", url))
  download.file(url, fname)
}
unzip(fname, exdir = "./data/shp")
#
# Read the map data
us_map <- readOGR("./data/shp/cb_2014_us_state_20m.shp", "cb_2014_us_state_20m")
states_map <- us_map[!us_map$STUSPS %in%
                        c('AS', 'DC', 'GU', 'MP', 'PR', 'VI'),]

```


Download and read the quakes data as before:


```{r, warning = F, message = F}
fn <- './data/usgs-quakes-dump.csv'
zname <- paste(fn, 'zip', sep = '.')
if (!file.exists(zname) || file.size(zname) < 2048){
  url <- paste("https://github.com/dannguyen/ok-earthquakes-RNotebook",
    "raw/master/data", zname, sep = '/')
  print(paste("Downloading: ", url))
  # note: if you have problems downloading from https, you might need to include
  # RCurl
  download.file(url, zname, method = "libcurl")
}
unzip(zname, exdir="data")
# read the data into a dataframe
usgs_data <- read.csv(fn, stringsAsFactors = FALSE)
```

Filter and mutate the data

```{r, warning = F, message = F}
# Remove all non earthquakes and events
# with magnitude less than 3.0:
quakes <- usgs_data %>% filter(mag >= 3.0, type == 'earthquake')

quakes$time <- as.Date(quakes$time)
quakes$year <- year(quakes$time)
quakes <- mutate(quakes, era = ifelse(year <= 2000, "1995-2000",
          ifelse(year <= 2005, "2001-2005",
          ifelse(year <= 2010, "2006-2010", "2011-2015"))))
```

```{r, warning = F, message = F}
sp_quakes <- SpatialPointsDataFrame(data = quakes,
                coords = quakes[,c("longitude", "latitude")])
sp_quakes@proj4string <- states_map@proj4string
# subset for earthquakes in the U.S.
xdf <- over(sp_quakes, states_map[, 'STUSPS'])
states_quakes <- cbind(sp_quakes, xdf) %>% filter(!is.na(STUSPS))
# add a convenience column for Oklahoma:
states_quakes <- mutate(states_quakes, is_OK = STUSPS == 'OK')
```



## Mapping the quakes


For mapping purposes, we'll make a contiguous-states only. Remember in the previous chapter, we saw how Oklahoma's recent earthquake activity outpaced all of the U.S., including Alaska and Hawaii. And more importantly, remember that I don't know how to transpose Alaska and Hawaii neatly on to an Albers projection:

```{r, warning = F, message = F}
cg_map <- states_map[!states_map$STUSPS %in% c('AK', 'HI'), ]
cg_quakes <- states_quakes[!states_quakes$STUSPS  %in% c('AK', 'HI'), ]
```

Trying to map all the quakes leads to the unavoidable problem of overplotting:

```{r, earthquakes_by_era_since_1995_overplotted, warning = F, message = F}
ggplot() +
  geom_polygon(data = cg_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = cg_quakes, aes(x = longitude, y = latitude), shape = 1, color = "red", alpha = 0.2) +
  coord_map("albers", lat0 = 38, latl = 42) +
  theme_dan_map() +
  ggtitle("M3.0+ earthquakes in U.S. since 1995")

```


By era:

Legend hack: http://stackoverflow.com/questions/5290003/how-to-set-legend-alpha-with-ggplot2

```{r, earthquakes_by_era_since_1995_plotted_by_era, warning = F, message = F}
ggplot() +
  geom_polygon(data = cg_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = cg_quakes, aes(x = longitude, y = latitude, color = era), shape = 4,  alpha = 0.2) +
  coord_map("albers", lat0 = 38, latl = 42) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_dan_map() +
  ggtitle("M3.0+ earthquakes in U.S. since 1995")

```

Small multiples:

```{r, small_multiples_earthquakes_by_era_since_1995, warning = F, message = F}
ggplot() +
  geom_polygon(data = cg_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = cg_quakes, aes(x = longitude, y = latitude), shape = 4,  alpha = 0.2, color = "red") +
  coord_map("albers", lat0 = 38, latl = 42) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_dan_map() +
  facet_wrap(~ era) +
  ggtitle("M3.0+ earthquakes in U.S. by time period")
```

Small multiples focused on Oklahoma:

```{r, small_multiples_OK_only, warning = F, message = F}
# Dataframe of just Oklahoma quakes:
ok_quakes <- filter(states_quakes, is_OK)
# map of just Oklahoma state:
ok_map <- states_map[states_map$STUSPS == 'OK',]
```

```{r, small_multiples_oklahoma_map_quakes, fig.cap = "Small Multiples Oklahoma"}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group), fill = "white", color = "#777777") +
  geom_point(data = ok_quakes, aes(x = longitude, y = latitude), shape = 4,  alpha = 0.5, color = "red") +
  coord_map("albers", lat0 = 38, latl = 42) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_dan_map() +
  facet_wrap(~ era) +
  ggtitle("M3.0+ earthquakes in Oklahoma by time period")
```













## Injection volumes

Download # http://www.occeweb.com/og/ogdatafiles2.htm


2013:

```{r, warning = F, message = F}
fname <- "./data/2013_UIC_Injection_Volumes_Report.xlsx"
if (!file.exists(fname)){
  url <- "http://www.occeweb.com/og/2013%20UIC%20Injection%20Volumes%20Report.xlsx"
  print(paste("Downloading: ", url))
  download.file(url, fname)
}
injections_data_2013 <- read_excel(fname)
injections_2013 <-  injections_data_2013 %>%
    mutate(Volume = as.numeric(Volume),
           API = as.character(API)) %>%
    # filter out rows with missing Volume or erroneous X/Y
    filter(!is.na(Volume),
           !is.na(X), X != 0,  X < -90, X > -100,
           !is.na(Y), Y != 0, Y > 33.5, Y < 40)
```


Aggregate the wells by their unique identifier and create a `total_volume` column:


```{r}
wells_2013 <-  as.data.frame(group_by(injections_2013, API, X, Y) %>%
    summarise(counts = n(), total_volume = sum(Volume)) %>%
    arrange(desc(counts)))
```




-------------
Map it:

```{r}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  geom_point(data = filter(wells_2013, total_volume < 1250000),
             aes(x = X, y = Y),
             alpha = 0.1 , color = 'yellow') +
  geom_point(data = filter(wells_2013, total_volume > 1250000),
             aes(x = X, y = Y),
             alpha = 0.1 , color = 'purple') +
  geom_point(data = ok_quakes, aes(x = longitude, y = latitude),
            alpha = 0.1, size = 0.3, shape = 1, color = 'red') +
  coord_map("albers", lat0 = 38, latl = 42) + theme_dan_map()
```



## Maps


TK: Justify the use of Hexbin map, similar to binning by year instead of day


Hexbin map without projection

Earthquakes:

```{r}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  stat_binhex(data = ok_quakes, aes(x = longitude, y = latitude, alpha = ..count..), bins = 30 ) +
  scale_fill_gradientn(colours=c("white","red")) +
  coord_equal() +
  theme_dan_map()
```



TK: http://stackoverflow.com/questions/13167531/ggplot2-multiple-stat-binhex-plots-with-different-color-gradients-in-one-image

overlay of injections and earthquakes


```{r}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  stat_summary_hex(data = wells_2013, aes(x = X, y = Y, z = total_volume), bins = 30 ) + scale_fill_gradientn(colours=c("white","green")) +
  stat_binhex(data = ok_quakes, aes(x = longitude, y = latitude, alpha = ..count..), bins = 30 ) +

  coord_equal() +
  theme_dan_map()
```




Hexbin map with injections
```{r}
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  stat_summary_hex(data = wells_2013, aes(x = X, y = Y, z = total_volume), alpha = 0.9, bins = 20 ) +
  geom_point(data = ok_quakes, aes(x = longitude, y = latitude),
           alpha = 0.1, size = 0.2, shape = 1, color = 'red')

```




-------------


```{r}

sp_ok_quakes <- SpatialPointsDataFrame(data = ok_quakes,
                          coords = ok_quakes[,c("longitude", "latitude")])
proj4string(sp_ok_quakes) <- proj4string(ok_map)

sp_wells_2013 <- SpatialPointsDataFrame(data = wells_2013,
                          coords = wells_2013[,c("X", "Y")])

proj4string(sp_wells_2013) <- proj4string(ok_map)

albers_crs <- CRS("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs")
ok_map.albers <- spTransform(ok_map, albers_crs)
ok_quakes.albers <- as.data.frame(spTransform(sp_ok_quakes, albers_crs))
wells_2013.albers <- as.data.frame(spTransform(sp_wells_2013, albers_crs))

###0-----------
# look ma, no coord_map
ggplot() +
  geom_polygon(data = ok_map.albers, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  geom_point(data = filter(wells_2013.albers, total_volume > 100000),
             aes(x = X, y = Y),
             alpha = 0.1 , color = 'yellow') +

  geom_point(data = ok_quakes.albers, aes(x = longitude, y = latitude),
            alpha = 0.1, size = 0.2, shape = 1, color = 'red')
```



# Gas prices

https://research.stlouisfed.org/fred2/series/DCOILWTICO/downloaddata


```{r}
fname <- './data/stlouisfed-oil-prices.csv'
if (!file.exists(fname)){
  curlstr <- paste("curl -s --data 'form%5Bnative_frequency%5D=Daily&form%5Bunits%5D=lin&form%5Bfrequency%5D=Daily&form%5Baggregation%5D=Average&form%5Bobs_start_date%5D=1986-01-02&form%5Bobs_end_date%5D=2015-08-24&form%5Bfile_format%5D=csv&form%5Bdownload_data_2%5D='", '-o', fname)
  print(paste("Downloading: ", fname))
  system(curlstr)
}
gasdata <- read.csv("./data/stlouisfed-oil-prices.csv", stringsAsFactors = F) %>%
  filter(year(DATE) >= 2008, VALUE != '.')  %>%
  mutate(week = floor_date(as.Date(DATE), 'week'), VALUE = as.numeric(VALUE), panel = "GAS") %>%
  group_by(week) %>% summarize(avg_value = mean(VALUE))


```







```{r}
okquakes_weekly <- mutate(ok_quakes, week = floor_date(time, 'week'), panel = 'Quakes') %>%
  filter(year(time) >= 2008) %>%
  group_by(week) %>%
  summarize(count = n())


gp <- ggplot() + scale_x_date(breaks = pretty_breaks(),
                              limits = c(as.Date('2008-01-01'), as.Date('2015-08-31')))

quakesg <- gp + geom_bar(data = okquakes_weekly, aes(x = week, y = count), stat = "identity", position = 'identity', color = 'black') +
  scale_y_continuous(expand = c(0, 0)) +
  ggtitle("Weekly Counts of M3.0+ Earthquakes in Oklahoma")

gasg <- gp + geom_line(data = gasdata, aes(x = week, y = avg_value), size = 0.5, color = 'black') +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 150)) +
  ggtitle("Weekly Average Oil Prices, Dollars per Barrel")
```


```{r}
# http://stackoverflow.com/questions/10197738/add-a-footnote-citation-outside-of-plot-area-in-r

annotations <- list(
  list(date = "2011-11-05", label = "5.6M earthquake hits Oklahoma", letter = 'A'),
  list(date = "2014-02-18", label = 'OGS states that "Overall, the majority, but not all, of the recent earthquakes appear\nto be the result of natural stresses."', letter = 'B'),
  list(date = "2015-04-21", label = 'OGS reverses its opinion: "The rates and trends in seismicity are very unlikely\nto represent a naturally occurring process"', letter = 'C')
)


datelines <- lapply(annotations, function(a){
  wk <- as.numeric(floor_date(as.Date(a$date), 'week'))
  geom_vline(xintercept = wk, color = "red",
             linetype = 'dashed')
})

datelabels <- lapply(annotations, function(a){
  dt <- as.Date(a$date)
  annotate("text", x = dt, y = Inf, size = rel(4.0),  label = a$letter, vjust = 1.0, fontface = 'bold', color = "red", hjust = 1.5)
})

ttheme <- theme(plot.title = element_text(size = 12))

footnotes = paste(lapply(annotations, function(a){
              paste(a$letter,
              paste(strftime(a$date, '%b %d, %Y'), a$label, sep = ' - '),
              sep = '. ')
    }),
  collapse = '\n')

p <- arrangeGrob(quakesg + datelines + datelabels + ttheme,
                 gasg + datelines + datelabels + ttheme,
                 bottom = textGrob(label = footnotes, x = unit(1, 'cm'),
                                         hjust = 0.0, vjust = 0.3,
                                         gp = gpar(fontsize = rel(10), fontfamily = "Gill Sans MT"))
                 )

plot.new()
grid.draw(p)
```




<!--
To render this file:
library(rmarkdown)
setwd("~/Dropbox/rprojs/ok-earthquakes-Rnotebook/")

this_file <- 'chapter-4-geocorrelation.Rmd'
render(this_file, output_dir = './builds',
  html_document(toc = TRUE, self_contained = F))

render(this_file, output_dir = './builds',
  md_document(variant = "markdown_github",
              preserve_yaml = TRUE))
-->


The study, titled "Oklahoma's Recent Earthquakes and Saltwater Disposal," was funded by the Stanford Center for Induced and Triggered Seismicity, an affiliate program at the School of Earth, Energy & Environmental Sciences.


> Active faults in Oklahoma might trigger an earthquake every few thousand years. However, by increasing the fluid pressure through disposal of wastewater into the Arbuckle formation in the three areas of concentrated seismicity – from about 20 million barrels per year in 1997 to about 400 million barrels per year in 2013 – humans have sped up this process dramatically. "The earthquakes in Oklahoma would have happened eventually," Walsh said. "But by injecting water into the faults and pressurizing them, we've advanced the clock and made them occur today."



http://news.stanford.edu/news/2015/june/okla-quake-drilling-061815.html



## Trying Google Maps


```{r}
library(ggmap)
ok_goog_map <- get_googlemap(center = c(lon = -99.007, lat = 35.38905),  size = c(450,250), zoom = 6, scale = 2, maptype = 'hybrid',
style = c(feature = "administrative.province", element = "labels", visibility = "off"))
```

With points

```{r}
ggmap(ok_goog_map, extent = 'panel') +
  geom_point(data = ok_quakes, aes(x = longitude, y = latitude), alpha = 0.2, shape = 4, colour = "red")
```


With hexbin:

```{r}
ggmap(ok_goog_map, extent = 'panel') +
  stat_binhex(data = ok_quakes, aes(x = longitude, y = latitude, alpha = ..count..), bins = 30 ) +
  scale_fill_gradientn(colours=c("white","red")) +
  guides(alpha = FALSE)
```


Focus on Oklahoma City area:


```{r}
okcity_goog_map  <- get_googlemap(center = c(lon = -97.437287, lat = 36.1815),  size = c(640,640), zoom = 9, scale = 2, maptype = 'hybrid',
style = c(feature = "administrative.province", element = "labels", visibility = "off"))

```

Hexbin
```{r}
ggmap(okcity_goog_map) +
  stat_binhex(data = ok_quakes, aes(x = longitude, y = latitude, color = ..count..), bins = 30, fill = NA, alpha = 0.5 ) +
  scale_color_gradientn(colours=c("white","red")) +
  guides(fill = FALSE) + theme_dan_map()

```



--------------

## Density map

```{r}
okqs <- filter(ok_quakes, year == 2010 | year == 2015)
ggplot() +
  geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = "white", color = "black") +
  geom_point(data = okqs, aes(x = longitude, y = latitude)) +
  #  stat_density2d(data = okqs, aes(x = longitude, y = latitude, fill = ..level..), geom = 'polygon') +
  #coord_map("albers", lat0 = 38, latl = 42) +
  theme_dan_map() +
  facet_wrap(~ year)
```

With Google maps:

```{r}
ok_goog_map <- get_googlemap(center = c(lon = -98.682862, lat = 35.517324),  size = c(500,500), zoom = 6, scale = 2, maptype = 'terrain',
style = c(feature = "administrative.province", element = "labels", visibility = "off"))
xqs <- filter(states_quakes, year >= 2010)

ggmap(ok_goog_map, extent = 'panel') +
    geom_polygon(data = ok_map, aes(x = long, y = lat, group = group),
               fill = NA, color = "#552200", size = 0.5) +
  geom_point(data = xqs, aes(x = longitude, y = latitude), color = "red", shape = 1) +
#  geom_text(data = xqs, aes(label = year, x = -97.8, y = 39.0), size = rel(7.0), vjust = 1.0, color = "black", face = dan_base_font()) +

#    annotate("text",  x = -97.8, y = 39.0, size = rel(4.0),
#             label = ok_map$year, vjust = 1.0, fontface = 'bold',
#             color = "red", hjust = 1.5) +
  theme_dan_map() +
  theme(
#        strip.text = element_blank(),
    strip.text = element_text(vjust = -5.2, size = rel(4.0)),
    panel.margin = unit(c(-1,-1,-1,-1), 'lines')
   ) +
      facet_wrap(~ year, ncol = 3)


```





## Things TODO

- Use USGS Geologic map data: https://mrdata.usgs.gov/geology/state/state.php?state=OK



